@using Journal.Services
@inject IAuthService AuthService
@inject NavigationManager Navigation

@if (isChecking)
{
    <div class="pin-loading">
        <div class="spinner"></div>
    </div>
}
else if (showPinEntry)
{
    <div class="pin-overlay">
        <div class="pin-container">
            <div class="pin-header">
                <div class="pin-icon">@((mode == PinMode.Create) ? "ðŸ†•" : "ðŸ”’")</div>
                <h2>@((mode == PinMode.Create) ? "Create PIN" : "Session Locked")</h2>
                <p>@((mode == PinMode.Create) ? "Set a 4-digit PIN for session security" : "Enter your PIN to resume")</p>
            </div>

            <div class="pin-display">
                @for (int i = 0; i < 4; i++)
                {
                    <div class="pin-dot @(pin.Length > i ? "filled" : "")"></div>
                }
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="pin-error">@errorMessage</div>
            }

            <div class="pin-keypad">
                @for (int i = 1; i <= 9; i++)
                {
                    var digit = i.ToString();
                    <button class="key-btn" @onclick="() => AppendDigit(digit)">@i</button>
                }
                <button class="key-btn special" @onclick="ClearPin">C</button>
                <button class="key-btn" @onclick='() => AppendDigit("0")'>0</button>
                <button class="key-btn special" @onclick="Backspace">âŒ«</button>
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                 <button class="btn-link" @onclick="Logout">Logout</button>
            </div>
        </div>
    </div>
}
else
{
    @ChildContent
}

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }

    private string pin = "";
    private string errorMessage = "";
    private bool showPinEntry = false;
    private bool isChecking = true;
    private PinMode mode = PinMode.Verify;

    private enum PinMode { Create, Verify }

    protected override async Task OnInitializedAsync()
    {
        await CheckStatus();
    }

    private async Task CheckStatus()
    {
        isChecking = true;
        
        // If not authenticated, let AuthGate handle it (we shouldn't be here or just pass through)
        if (!AuthService.IsAuthenticated)
        {
            showPinEntry = false;
            isChecking = false;
            return;
        }

        var hasPin = await AuthService.HasPinAsync();
        
        if (!hasPin)
        {
            mode = PinMode.Create;
            showPinEntry = true;
        }
        else if (AuthService.IsSessionLocked)
        {
            mode = PinMode.Verify;
            showPinEntry = true;
        }
        else
        {
            showPinEntry = false;
        }

        isChecking = false;
    }

    private async Task AppendDigit(string digit)
    {
         if (pin.Length < 4)
        {
            pin += digit;
            errorMessage = "";
            StateHasChanged();

            if (pin.Length == 4)
            {
                await SubmitPin();
            }
        }
    }

    private void Backspace()
    {
        if (pin.Length > 0)
        {
            pin = pin.Substring(0, pin.Length - 1);
        }
    }

    private void ClearPin()
    {
        pin = "";
        errorMessage = "";
    }

    private async Task SubmitPin()
    {
        await Task.Delay(100); // Visual delay

        if (mode == PinMode.Create)
        {
            var success = await AuthService.SetPinAsync(pin);
            if (success)
            {
                showPinEntry = false;
            }
            else
            {
                errorMessage = "Failed to set PIN.";
                pin = "";
            }
        }
        else
        {
            var isValid = await AuthService.VerifyPinAsync(pin);
            if (isValid)
            {
                showPinEntry = false;
            }
            else
            {
                pin = "";
                errorMessage = "Incorrect PIN. Please try again.";
            }
        }
        StateHasChanged();
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/Login", true);
    }
}
