@page "/JournalTimeline"
@layout MainLayout
@inject IJournalService JournalService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="container">
    <!-- Header -->
    <div class="header">
        <h1>üìö My Journal Timeline</h1>
        <div class="header-actions">
            <div class="view-toggle">
                <button class="view-btn @(viewMode == "Timeline" ? "active" : "")" @onclick='() => SetViewMode("JournalTimeline")'>Timeline</button>
                <button class="view-btn @(viewMode == "Calendar" ? "active" : "")" @onclick="NavigateToCalendar">Calendar</button>
            </div>
            <button class="btn btn-primary" @onclick="NavigateToNewEntry">+ New Entry</button>
        </div>
    </div>

    <!-- Filters Bar -->
    <div class="filters-bar">
        <div class="search-box">
            <span class="search-icon"><i class="bi bi-search"></i></span>
            <input type="text" class="search-input" placeholder="Search entries..." 
                   @bind="searchTerm" @bind:after="ApplyFilters" />
        </div>
        
        <select class="filter-dropdown" @bind="selectedMood" @bind:after="ApplyFilters">
            <option value="">All Moods</option>
            <option value="Happy">üòä Happy</option>
            <option value="Calm">üòå Calm</option>
            <option value="Neutral">üòê Neutral</option>
            <option value="Reflective">üòî Reflective</option>
            <option value="Sad">üò¢ Sad</option>
        </select>

        <select class="filter-dropdown" @bind="selectedTag" @bind:after="ApplyFilters">
            <option value="">All Tags</option>
            @foreach (var tag in availableTags)
            {
                <option value="@tag">@tag</option>
            }
        </select>

        <select class="filter-dropdown" @bind="dateFilter" @bind:after="ApplyFilters">
            <option value="ThisYear">This Year</option>
            <option value="ThisMonth">This Month</option>
            <option value="Last7Days">Last 7 Days</option>
            <option value="AllTime">All Time</option>
        </select>
    </div>

    <!-- Timeline Container -->
    <div class="timeline-container">
        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value">@totalEntries</div>
                <div class="stat-label">Total Entries</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">@currentStreak</div>
                <div class="stat-label">Current Streak</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">@thisMonthEntries</div>
                <div class="stat-label">This Month</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">@avgWords</div>
                <div class="stat-label">Avg Words</div>
            </div>
        </div>

        @if (isLoading)
        {
            <div style="text-align: center; padding: 2rem;">
                <p>Loading entries...</p>
            </div>
        }
        else if (!displayedEntries.Any())
        {
            <div style="text-align: center; padding: 2rem;">
                <p>No entries found. <button class="btn btn-primary" @onclick="NavigateToNewEntry">Create your first entry!</button></p>
            </div>
        }
        else
        {
            <!-- Timeline -->
            <div class="timeline">
                @foreach (var monthGroup in groupedEntries)
                {
                    <div class="timeline-section">
                        <div class="timeline-month">
                            <div class="month-marker"></div>
                            <span class="month-label">@monthGroup.Key</span>
                            <span class="month-count">@monthGroup.Value.Count entry@(monthGroup.Value.Count != 1 ? "ies" : "")</span>
                        </div>

                        @foreach (var entry in monthGroup.Value)
                        {
                            <div class="timeline-entry">
                                <div class="entry-card">
                                    <div class="entry-header">
                                        <div class="entry-date-time">
                                            <span class="entry-date">@entry.CreatedAt.ToString("dddd, MMM dd")</span>
                                            <span class="entry-time">@entry.CreatedAt.ToString("h:mm tt")</span>
                                        </div>
                                        <span class="entry-mood mood-@entry.Mood.ToLower()">@GetMoodEmoji(entry.Mood) @entry.Mood</span>
                                    </div>
                                    <h3 class="entry-title">@entry.Title</h3>
                                    <p class="entry-preview">
                                        @GetPreview(entry.Content)
                                    </p>
                                    <div class="entry-footer">
                                        @if (!string.IsNullOrEmpty(entry.Tags))
                                        {
                                            <div class="entry-tags">
                                                @foreach (var tag in entry.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
                                                {
                                                    <span class="tag">#@tag</span>
                                                }
                                            </div>
                                        }
                                        <div class="entry-actions">
                                            <button class="action-btn" title="Edit" @onclick="() => EditEntry(entry.Id)">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="action-btn" title="Share" @onclick="() => ShareEntry(entry)">
                                                <i class="bi bi-share"></i>
                                            </button>
                                            <button class="action-btn" title="Delete" @onclick="() => DeleteEntry(entry.Id)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    private List<JournalDisplayModel> allEntries = new();
    private List<JournalDisplayModel> displayedEntries = new();
    private Dictionary<string, List<JournalDisplayModel>> groupedEntries = new();
    private bool isLoading = true;
    private string searchTerm = string.Empty;
    private string selectedMood = string.Empty;
    private string selectedTag = string.Empty;
    private string dateFilter = "AllTime";
    private string viewMode = "Timeline";
    private int totalEntries = 0;
    private int currentStreak = 0;
    private int thisMonthEntries = 0;
    private string avgWords = "0";
    private HashSet<string> availableTags = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        isLoading = true;
        try
        {
            var allResult = await JournalService.GetAllEntriesAsync();
            if (allResult.Success)
            {
                allEntries = allResult.Data ?? new();
                displayedEntries = allEntries;
            }
            
            var totalResult = await JournalService.GetTotalEntriesCountAsync();
            if (totalResult.Success) totalEntries = totalResult.Data;

            var streakResult = await JournalService.GetCurrentStreakAsync();
            if (streakResult.Success) currentStreak = streakResult.Data;

            var monthResult = await JournalService.GetThisMonthEntriesCountAsync();
            if (monthResult.Success) thisMonthEntries = monthResult.Data;
            
            var totalWords = allEntries.Sum(e => e.WordCount);
            avgWords = allEntries.Count > 0 ? (totalWords / allEntries.Count).ToString() : "0";
            
            // Extract unique tags
            availableTags = new HashSet<string>();
            foreach (var entry in allEntries)
            {
                if (!string.IsNullOrEmpty(entry.Tags))
                {
                    var entryTags = entry.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
                    foreach (var tag in entryTags)
                    {
                        availableTags.Add(tag);
                    }
                }
            }
            
            GroupEntries();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private Task ApplyFilters()
    {
        displayedEntries = allEntries;

        // Apply date filter
        var now = DateTime.Now;
        displayedEntries = dateFilter switch
        {
            "ThisYear" => displayedEntries.Where(e => e.CreatedAt.Year == now.Year).ToList(),
            "ThisMonth" => displayedEntries.Where(e => e.CreatedAt.Year == now.Year && e.CreatedAt.Month == now.Month).ToList(),
            "Last7Days" => displayedEntries.Where(e => e.CreatedAt >= now.AddDays(-7)).ToList(),
            _ => displayedEntries
        };

        // Apply mood filter
        if (!string.IsNullOrEmpty(selectedMood))
        {
            displayedEntries = displayedEntries.Where(e => e.Mood == selectedMood).ToList();
        }

        // Apply tag filter
        if (!string.IsNullOrEmpty(selectedTag))
        {
            displayedEntries = displayedEntries.Where(e => 
                !string.IsNullOrEmpty(e.Tags) && 
                e.Tags.Contains(selectedTag, StringComparison.OrdinalIgnoreCase)).ToList();
        }

        // Apply search filter
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            displayedEntries = displayedEntries.Where(e => 
                e.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                e.Content.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                (!string.IsNullOrEmpty(e.Tags) && e.Tags.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))).ToList();
        }

        GroupEntries();
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void GroupEntries()
    {
        groupedEntries = displayedEntries
            .GroupBy(e => e.CreatedAt.ToString("MMMM yyyy"))
            .OrderByDescending(g => g.First().CreatedAt)
            .ToDictionary(g => g.Key, g => g.OrderByDescending(e => e.CreatedAt).ToList());
    }

    private void SetViewMode(string mode)
    {
        viewMode = mode;
        if (mode == "Calendar")
        {
            NavigateToCalendar();
        }
        StateHasChanged();
    }

    private void NavigateToNewEntry()
    {
        Navigation.NavigateTo("/JournalEntry");
    }

    private void NavigateToCalendar()
    {
        Navigation.NavigateTo("/Calendar");
    }

    private void EditEntry(int id)
    {
        Navigation.NavigateTo($"/JournalEntry?id={id}");
    }

    private async Task ShareEntry(JournalDisplayModel entry)
    {
        var shareText = $"{entry.Title}\n\n{entry.Content}\n\nTags: {entry.Tags}";
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", shareText);
            await JSRuntime.InvokeVoidAsync("alert", "Entry copied to clipboard!");
        }
        catch
        {
            await JSRuntime.InvokeVoidAsync("alert", "Failed to share entry.");
        }
    }

    private async Task DeleteEntry(int id)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this entry?");
        if (confirmed)
        {
            var result = await JournalService.DeleteEntryAsync(id);
            if (result.Success && result.Data)
            {
                await LoadData();
                await JSRuntime.InvokeVoidAsync("alert", "Entry deleted successfully!");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Failed to delete entry.");
            }
        }
    }

    private string GetPreview(string content)
    {
        if (string.IsNullOrWhiteSpace(content))
            return string.Empty;
        
        var preview = content.Length > 150 ? content.Substring(0, 150) + "..." : content;
        return preview;
    }

    private string GetMoodEmoji(string mood)
    {
        return mood switch
        {
            "Happy" => "üòä",
            "Calm" => "üòå",
            "Neutral" => "üòê",
            "Reflective" => "üòî",
            "Sad" => "üò¢",
            _ => "üìù"
        };
    }
}
