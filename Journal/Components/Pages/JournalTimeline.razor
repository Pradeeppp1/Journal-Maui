@page "/JournalTimeline"
@layout MainLayout
@using Journal.Services
@using Journal.Models
@inject IJournalService JournalService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="container">
    <!-- Header -->
    <div class="header">
        <h1>üìö My Journal Timeline</h1>
        <div class="header-actions">
            <div class="view-toggle">
                <button class="view-btn active">Timeline</button>
                <button class="view-btn" @onclick='() => Navigation.NavigateTo("/Calendar")'>Calendar</button>
            </div>
            <button class="btn btn-secondary" @onclick="ShowExportDialog">
                <i class="bi bi-download"></i> Export
            </button>
            <button class="btn btn-primary" @onclick='() => Navigation.NavigateTo("/JournalEntry")'>+ New Entry</button>
        </div>
    </div>

    <!-- Filters Bar -->
    <div class="filters-bar">
        <div class="search-box">
            <i class="bi bi-search search-icon"></i>
            <input type="text" class="search-input" placeholder="Search entries..." 
                   @bind="searchTerm" @bind:event="oninput" @onkeyup="HandleKeyUp" />
        </div>
        
        <select class="filter-dropdown" @bind="selectedMood" @bind:after="ApplyFilters">
            <option value="">All Moods</option>
            <option value="Happy">üòä Happy</option>
            <option value="Calm">üòå Calm</option>
            <option value="Neutral">üòê Neutral</option>
            <option value="Reflective">üòî Reflective</option>
            <option value="Sad">üò¢ Sad</option>
        </select>

        <select class="filter-dropdown" @bind="selectedTag" @bind:after="ApplyFilters">
            <option value="">All Tags</option>
            @foreach (var tag in availableTags)
            {
                <option value="@tag">@tag</option>
            }
        </select>

        <select class="filter-dropdown" @bind="dateFilter" @bind:after="ApplyFilters">
            <option value="AllTime">All Time</option>
            <option value="Today">Today</option>
            <option value="Last7Days">Last 7 Days</option>
            <option value="ThisMonth">This Month</option>
            <option value="ThisYear">This Year</option>
        </select>
    </div>

    <!-- Timeline Container -->
    <div class="timeline-container">
        @if (isLoading && pageNum == 1)
        {
            <div class="loading-state">
                <div class="spinner"></div>
                <p>Loading your memories...</p>
            </div>
        }
        else if (!displayedEntries.Any() && !isLoading)
        {
            <div class="empty-state">
                <div class="empty-icon">üìî</div>
                <h3>No entries found</h3>
                <p>Try adjusting your filters or start writing a new memory.</p>
                <button class="btn btn-primary" @onclick='() => Navigation.NavigateTo("/JournalEntry")'>Create First Entry</button>
            </div>
        }
        else
        {
            <div class="timeline">
                @foreach (var monthGroup in groupedEntries)
                {
                    <div class="timeline-section">
                        <div class="timeline-month">
                            <div class="month-marker"></div>
                            <span class="month-label">@monthGroup.Key</span>
                        </div>

                        @foreach (var entry in monthGroup.Value)
                        {
                            <div class="timeline-entry">
                                <div class="entry-card">
                                    <div class="entry-header">
                                        <div class="entry-date-time">
                                            <span class="entry-date">@entry.CreatedAt.ToString("dddd, MMM dd")</span>
                                            <span class="entry-time">@entry.CreatedAt.ToString("h:mm tt")</span>
                                        </div>
                                        <div class="mood-badges">
                                            <span class="entry-mood mood-@entry.Mood.ToLower()">@GetMoodEmoji(entry.Mood) @entry.Mood</span>
                                            @if (!string.IsNullOrEmpty(entry.SecondaryMoods))
                                            {
                                                @foreach (var sm in entry.SecondaryMoods.Split(',', StringSplitOptions.RemoveEmptyEntries))
                                                {
                                                    <span class="entry-mood secondary mood-@sm.Trim().ToLower()">@GetMoodEmoji(sm.Trim())</span>
                                                }
                                            }
                                        </div>
                                    </div>
                                    <h3 class="entry-title">@entry.Title</h3>
                                    <p class="entry-preview">@GetPreview(entry.Content)</p>
                                    <div class="entry-footer">
                                        @if (!string.IsNullOrEmpty(entry.Tags))
                                        {
                                            <div class="entry-tags">
                                                @foreach (var tag in entry.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries))
                                                {
                                                    <span class="tag">#@tag.Trim()</span>
                                                }
                                            </div>
                                        }
                                        <div class="entry-actions">
                                            <button class="action-btn" @onclick="() => EditEntry(entry.Id)"><i class="bi bi-pencil"></i></button>
                                            <button class="action-btn" @onclick="() => DeleteEntry(entry.Id)"><i class="bi bi-trash"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>

            @if (hasMoreEntries)
            {
                <div class="load-more-container">
                    <button class="btn btn-secondary" @onclick="LoadMore" disabled="@isLoading">
                        @(isLoading ? "Loading..." : "Load More Entries")
                    </button>
                </div>
            }
        }
    </div>
</div>

@if (showExportModal)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <h3>Export Journal</h3>
            <p>Select date range to export your entries as PDF (Text format).</p>
            <div class="form-group">
                <label>Start Date</label>
                <input type="date" class="form-control" @bind="exportStartDate" />
            </div>
            <div class="form-group">
                <label>End Date</label>
                <input type="date" class="form-control" @bind="exportEndDate" />
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" @onclick="() => showExportModal = false">Cancel</button>
                <button class="btn btn-primary" @onclick="DoExport">Export Now</button>
            </div>
        </div>
    </div>
}

@code {
    private List<JournalDisplayModel> allLoadedEntries = new();
    private List<JournalDisplayModel> displayedEntries = new();
    private Dictionary<string, List<JournalDisplayModel>> groupedEntries = new();
    private bool isLoading = true;
    private int pageNum = 1;
    private const int pageSize = 5; // Smaller for testing pagination
    private bool hasMoreEntries = true;

    // Filters
    private string searchTerm = string.Empty;
    private string selectedMood = string.Empty;
    private string selectedTag = string.Empty;
    private string dateFilter = "AllTime";
    private HashSet<string> availableTags = new();

    // Export
    private bool showExportModal = false;
    private DateTime exportStartDate = DateTime.Today.AddMonths(-1);
    private DateTime exportEndDate = DateTime.Today;

    protected override async Task OnInitializedAsync()
    {
        await LoadEntries();
    }

    private async Task LoadEntries(bool append = false)
    {
        isLoading = true;
        if (!append) 
        {
            pageNum = 1;
            allLoadedEntries.Clear();
        }

        var result = await JournalService.GetAllEntriesAsync(pageNum, pageSize);
        if (result.Success && result.Data != null)
        {
            if (append)
            {
                allLoadedEntries.AddRange(result.Data);
            }
            else
            {
                allLoadedEntries = result.Data;
            }
            
            hasMoreEntries = result.Data.Count == pageSize;
            ApplyFilters();
            ExtractTags();
        }
        
        isLoading = false;
        StateHasChanged();
    }

    private async Task LoadMore()
    {
        pageNum++;
        await LoadEntries(true);
    }

    private void ExtractTags()
    {
        foreach (var entry in allLoadedEntries)
        {
            if (!string.IsNullOrEmpty(entry.Tags))
            {
                foreach (var tag in entry.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries))
                {
                    availableTags.Add(tag.Trim());
                }
            }
        }
    }

    private void ApplyFilters()
    {
        var query = allLoadedEntries.AsEnumerable();

        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            query = query.Where(e => e.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) || 
                                    e.Content.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrEmpty(selectedMood))
        {
            query = query.Where(e => e.Mood == selectedMood || 
                                    (e.SecondaryMoods != null && e.SecondaryMoods.Contains(selectedMood)));
        }

        if (!string.IsNullOrEmpty(selectedTag))
        {
            query = query.Where(e => e.Tags != null && e.Tags.Contains(selectedTag));
        }

        var now = DateTime.Today;
        query = dateFilter switch
        {
            "Today" => query.Where(e => e.CreatedAt.Date == now),
            "Last7Days" => query.Where(e => e.CreatedAt.Date >= now.AddDays(-7)),
            "ThisMonth" => query.Where(e => e.CreatedAt.Year == now.Year && e.CreatedAt.Month == now.Month),
            "ThisYear" => query.Where(e => e.CreatedAt.Year == now.Year),
            _ => query
        };

        displayedEntries = query.ToList();
        GroupEntries();
    }

    private void GroupEntries()
    {
        groupedEntries = displayedEntries
            .OrderByDescending(e => e.CreatedAt)
            .GroupBy(e => e.CreatedAt.ToString("MMMM yyyy"))
            .ToDictionary(g => g.Key, g => g.ToList());
    }

    private Task HandleKeyUp(KeyboardEventArgs e)
    {
        ApplyFilters();
        return Task.CompletedTask;
    }

    private void EditEntry(int id) => Navigation.NavigateTo($"/JournalEntry?id={id}");

    private async Task DeleteEntry(int id)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Delete this memory forever?");
        if (confirmed)
        {
            await JournalService.DeleteEntryAsync(id);
            await LoadEntries();
        }
    }

    private void ShowExportDialog() => showExportModal = true;

    private async Task DoExport()
    {
        var result = await JournalService.ExportEntriesToPdfAsync(exportStartDate, exportEndDate);
        if (result.Success && result.Data != null)
        {
            var fileName = $"Journal_Export_{DateTime.Now:yyyyMMdd}.txt";
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(result.Data));
            showExportModal = false;
            await JSRuntime.InvokeVoidAsync("alert", "Exported successfully! Check your downloads.");
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Export failed: {result.Message}");
        }
    }

    private string GetPreview(string html)
    {
        if (string.IsNullOrEmpty(html)) return "No content";
        var plainText = System.Text.RegularExpressions.Regex.Replace(html, "<.*?>", string.Empty);
        return plainText.Length > 150 ? plainText.Substring(0, 150) + "..." : plainText;
    }

    private string GetMoodEmoji(string mood) => mood.ToLower() switch
    {
        "happy" => "üòä",
        "calm" => "üòå",
        "neutral" => "üòê",
        "reflective" => "üòî",
        "sad" => "üò¢",
        _ => "üìù"
    };
}
