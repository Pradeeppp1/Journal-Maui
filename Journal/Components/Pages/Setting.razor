@page "/Setting"
@inject IProfileService ProfileService
@inject IJournalService JournalService
@inject IAuthService AuthService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<div class="container">
    <div class="header">
        <h1>‚öôÔ∏è Settings</h1>
    </div>

    @if (isLoading)
    {
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Loading settings...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-state">
            <h3>Error Loading Settings</h3>
            <p>@errorMessage</p>
            <button class="btn btn-primary" @onclick="LoadProfile">Retry</button>
        </div>
    }
    else
    {
        <div class="settings-layout">
            <!-- Profile Column -->
            <div class="settings-panel">
                <section class="settings-card">
                    <div class="card-header">
                        <h2 class="card-title">User Profile</h2>
                        <p class="card-desc">Manage how you appear in your journal</p>
                    </div>

                    <div class="profile-preview">
                        <div class="profile-avatar">@profile.Initials</div>
                        <div class="profile-info-mini">
                            <span class="mini-name">@profile.FullName</span>
                            <span class="mini-handle">@@@(string.IsNullOrEmpty(profile.Username) ? "username" : profile.Username)</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" class="form-control" @bind="profile.FullName" placeholder="Your Name" />
                    </div>

                    <div class="form-group">
                        <label>Username</label>
                        <div class="input-with-icon">
                            <span class="input-icon">@@</span>
                            <input type="text" class="form-control" @bind="profile.Username" placeholder="handle" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" class="form-control" @bind="profile.Email" placeholder="your@email.com" />
                    </div>

                    <div class="form-group">
                        <label>Bio</label>
                        <textarea class="form-control" @bind="profile.Bio" placeholder="Tell your journal about yourself..." rows="3"></textarea>
                    </div>

                    <div class="card-actions">
                        <button class="btn btn-primary w-100" @onclick="UpdateProfile">Save Profile Changes</button>
                    </div>
                </section>
            </div>

            <!-- Configuration Column -->
            <div class="settings-panel">
                <!-- Security Card -->
                <section class="settings-card">
                    <div class="card-header">
                        <h2 class="card-title">Security & Privacy</h2>
                        <p class="card-desc">Keep your memories safe from prying eyes</p>
                    </div>

                    <div class="setting-row">
                        <div class="setting-text">
                            <span class="setting-label">PIN Lock Protection</span>
                            <span class="setting-desc">Require a code every time you open the app</span>
                        </div>
                        <div class="setting-control">
                             <div class="toggle-container @(hasPin ? "on" : "off")" @onclick="TogglePinManagement">
                                 <div class="toggle-handle"></div>
                             </div>
                        </div>
                    </div>

                    @if (showPinManagement)
                    {
                        <div class="pin-config-box fade-in">
                            <div class="form-group">
                                <label>@(hasPin ? "New 4-Digit PIN" : "Create 4-Digit PIN")</label>
                                <input type="password" maxlength="4" class="form-control pin-input" @bind="newPin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                            </div>
                            <div class="pin-actions">
                                <button class="btn btn-primary btn-sm" @onclick="SavePin">Set PIN</button>
                                @if (hasPin)
                                {
                                    <button class="btn btn-outline-danger btn-sm" @onclick="RemovePin">Disable PIN</button>
                                }
                            </div>
                        </div>
                    }
                </section>

                <!-- System & Data -->
                <section class="settings-card danger">
                    <div class="card-header">
                        <h2 class="card-title">Maintenance</h2>
                        <p class="card-desc">Advanced data management options</p>
                    </div>

                    <div class="maintenance-actions">
                        <div class="m-action">
                            <div class="m-text">
                                <span class="m-label">Clear All Journal Entries</span>
                                <span class="m-desc">Deletes all entries but keeps your profile</span>
                            </div>
                            <button class="btn btn-outline-danger btn-sm" @onclick="ClearAllData">Wipe Entries</button>
                        </div>

                        <div class="m-action">
                            <div class="m-text">
                                <span class="m-label">Total System Reset</span>
                                <span class="m-desc">Reset database and clear all local data</span>
                            </div>
                            <button class="btn btn-danger btn-sm" @onclick="ResetDatabase">Hard Reset</button>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    }
</div>

@code {
    private ProfileDisplayModel profile = new();
    private bool isLoading = true;
    private bool showPinManagement = false;
    private bool hasPin = false;
    private string newPin = "";
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadProfile();
        hasPin = await AuthService.HasPinAsync();
        showPinManagement = hasPin;
    }

    private async Task LoadProfile()
    {
        isLoading = true;
        errorMessage = "";
        try
        {
            var result = await ProfileService.GetProfileAsync();
            if (result.Success && result.Data != null)
            {
                profile = result.Data;
            }
            else
            {
                errorMessage = result.Message;
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Service unavailable: " + ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task UpdateProfile()
    {
        var model = new ProfileViewModel
        {
            FullName = profile.FullName,
            Email = profile.Email,
            Username = profile.Username,
            Bio = profile.Bio,
            IsDarkMode = profile.IsDarkMode,
            IsCompactView = profile.IsCompactView
        };

        var result = await ProfileService.UpdateProfileAsync(model);
        if (result.Success)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Settings updated successfully! ‚ú®");
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("alert", "Update failed: " + result.Message);
        }
    }

    private void TogglePinManagement()
    {
        showPinManagement = !showPinManagement;
    }

    private async Task SavePin()
    {
        if (newPin.Length == 4 && newPin.All(char.IsDigit))
        {
            var success = await AuthService.SetPinAsync(newPin);
            if (success)
            {
                hasPin = true;
                await JSRuntime.InvokeVoidAsync("alert", "PIN protection enabled. üîí");
                newPin = "";
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("alert", "Failed to save PIN.");
            }
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("alert", "Please enter exactly 4 digits.");
        }
    }

    private async Task RemovePin()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Disable PIN security? Your journal will be accessible to anyone with this device.");
        if (confirmed)
        {
            var success = await AuthService.SetPinAsync(""); // Empty PIN disables it
            if (success)
            {
                hasPin = false;
                showPinManagement = false;
                await JSRuntime.InvokeVoidAsync("alert", "PIN lock disabled.");
            }
        }
    }

    private async Task ClearAllData()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Delete all entries? This action is irreversible.");
        if (confirmed)
        {
            isLoading = true;
            try
            {
                var entries = await JournalService.GetAllEntriesAsync(1, 10000);
                if (entries.Success && entries.Data != null)
                {
                    foreach (var entry in entries.Data)
                    {
                        await JournalService.DeleteEntryAsync(entry.Id);
                    }
                }
                await JSRuntime.InvokeVoidAsync("alert", "Your journal has been cleared.");
                Navigation.NavigateTo("/", true);
            }
            finally
            {
                isLoading = false;
            }
        }
    }

    private async Task ResetDatabase()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "CRITICAL: This will destroy the database file and clear everything. Continue?");
        if (confirmed)
        {
            isLoading = true;
            try 
            {
                var dbPath = Path.Combine(FileSystem.AppDataDirectory, "journal.db");
                if (File.Exists(dbPath))
                {
                    File.Delete(dbPath);
                }
                await JSRuntime.InvokeVoidAsync("alert", "System has been reset. The app will now reload.");
                Navigation.NavigateTo("/", true);
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("alert", "Error resetting system: " + ex.Message);
            }
            finally
            {
                isLoading = false;
            }
        }
    }
}