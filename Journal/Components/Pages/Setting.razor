@page "/Setting"
@inject IProfileService ProfileService
@inject ISecurityService SecurityService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<div class="container @(profile.IsDarkMode ? "dark-theme" : "")">
    <div class="header">
        <h1>Settings</h1>
        <div style="width: 100px;"></div>
    </div>

    @if (isLoading)
    {
        <div class="loading-overlay">
            <div class="spinner"></div>
            <p>Loading settings...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-container">
            <h2>Error Loading Settings</h2>
            <p>@errorMessage</p>
            <button class="btn btn-primary" @onclick="LoadProfile">Retry</button>
        </div>
    }
    else
    {
        <main class="settings-content">
            <!-- Profile Section -->
            <section class="settings-section">
                <div class="section-header">
                    <h2 class="section-title">Profile</h2>
                    <p class="section-description">Update your personal information</p>
                </div>

                <div class="profile-picture-section">
                    <div class="profile-avatar">
                        @profile.Initials
                    </div>
                    <div class="profile-actions">
                        <button class="btn btn-secondary">Change Photo</button>
                        <button class="btn btn-danger">Remove</button>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Full Name</div>
                        <div class="setting-desc">Visible to other users when you share entries</div>
                    </div>
                    <div class="setting-control">
                        <input type="text" class="input-field" @bind="profile.FullName" />
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Email Address</div>
                        <div class="setting-desc">Used for notifications and backup</div>
                    </div>
                    <div class="setting-control">
                        <input type="email" class="input-field" @bind="profile.Email" />
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Username</div>
                        <div class="setting-desc">Your unique handle within the app</div>
                    </div>
                    <div class="setting-control">
                        <input type="text" class="input-field" @bind="profile.Username" />
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Bio</div>
                        <div class="setting-desc">A short description of yourself</div>
                    </div>
                    <div class="setting-control">
                        <textarea class="input-field textarea-field" @bind="profile.Bio"></textarea>
                    </div>
                </div>

                <div style="padding-top: 1.5rem; text-align: right;">
                    <button class="btn btn-primary" @onclick="UpdateProfile">Save Changes</button>
                </div>
            </section>

            <!-- Appearance Section -->
            <section class="settings-section">
                <div class="section-header">
                    <h2 class="section-title">Appearance</h2>
                    <p class="section-description">Customize your visual experience</p>
                </div>
            </section>

            <!-- Security Section -->
            <section class="settings-section">
                <div class="section-header">
                    <h2 class="section-title">Security</h2>
                    <p class="section-description">Manage your privacy and access</p>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">PIN Lock</div>
                        <div class="setting-desc">Lock your journal with a 4-digit code</div>
                    </div>
                    <div class="setting-control">
                        <div class="toggle-switch @(SecurityService.IsPinSet() ? "active" : "")" @onclick="TogglePinManagement"></div>
                    </div>
                </div>

                @if (showPinManagement)
                {
                    <div class="pin-setup">
                        <div class="setting-row">
                            <div class="setting-info">
                                <div class="setting-label">PIN Code</div>
                                <div class="setting-desc">@(SecurityService.IsPinSet() ? "Change your existing PIN" : "Setup a new access code")</div>
                            </div>
                            <div class="setting-control">
                                <input type="password" maxlength="4" class="input-field" style="width: 100px; text-align: center;" @bind="newPin" />
                            </div>
                        </div>
                        <div class="pin-actions">
                            <button class="btn btn-primary" @onclick="SavePin">Save PIN</button>
                            @if (SecurityService.IsPinSet())
                            {
                                <button class="btn btn-danger" @onclick="RemovePin">Disable Lock</button>
                            }
                        </div>
                    </div>
                }
            </section>

            <!-- Maintenance Section -->
            <section class="settings-section danger-zone">
                <div class="section-header">
                    <h2 class="section-title">Maintenance</h2>
                    <p class="section-description">Critical system operations</p>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Database Management</div>
                        <div class="setting-desc">Rebuild system tables in case of errors</div>
                    </div>
                    <div class="setting-control">
                        <button class="btn btn-danger" @onclick="ResetDatabase">Rebuild DB</button>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-info">
                        <div class="setting-label">Permanently Delete Data</div>
                        <div class="setting-desc">Clear all entries from this device</div>
                    </div>
                    <div class="setting-control">
                        <button class="btn btn-danger" @onclick="ClearAllData">Delete All</button>
                    </div>
                </div>
            </section>
        </main>
    }
</div>

@code {
    private ProfileDisplayModel profile = new();
    private bool isLoading = true;
    private bool showPinManagement = false;
    private string newPin = "";
    private string errorMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadProfile();
        showPinManagement = SecurityService.IsPinSet();
    }

    private async Task LoadProfile()
    {
        isLoading = true;
        errorMessage = "";
        try
        {
            var result = await ProfileService.GetProfileAsync();
            if (result.Success && result.Data != null)
            {
                profile = result.Data;
            }
            else
            {
                errorMessage = result.Message;
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Service unavailable: " + ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task UpdateProfile()
    {
        var model = new ProfileViewModel
        {
            FullName = profile.FullName,
            Email = profile.Email,
            Username = profile.Username,
            Bio = profile.Bio,
            IsDarkMode = profile.IsDarkMode,
            IsCompactView = profile.IsCompactView
        };

        var result = await ProfileService.UpdateProfileAsync(model);
        if (result.Success)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Profile updated.");
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("alert", "Update failed: " + result.Message);
        }
    }

    private async Task ToggleDarkMode()
    {
        profile.IsDarkMode = !profile.IsDarkMode;
        await UpdateProfile();
    }

    private async Task ToggleCompactView()
    {
        profile.IsCompactView = !profile.IsCompactView;
        await UpdateProfile();
    }

    private void TogglePinManagement()
    {
        showPinManagement = !showPinManagement;
    }

    private async Task SavePin()
    {
        if (newPin.Length == 4 && newPin.All(char.IsDigit))
        {
            SecurityService.SetPin(newPin);
            SecurityService.IsAuthenticated = true;
            await JSRuntime.InvokeVoidAsync("alert", "PIN protected.");
            newPin = "";
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("alert", "Enter 4 digits.");
        }
    }

    private async Task RemovePin()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Disable PIN lock?");
        if (confirmed)
        {
            SecurityService.ClearPin();
            showPinManagement = false;
            await JSRuntime.InvokeVoidAsync("alert", "PIN disabled.");
        }
    }

    private async Task ClearAllData()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Delete all data? This cannot be undone.");
        if (confirmed)
        {
            await JSRuntime.InvokeVoidAsync("alert", "Maintenance feature coming soon.");
        }
    }

    private async Task ResetDatabase()
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "This will wipe the database and recreate it. Continue?");
        if (confirmed)
        {
            isLoading = true;
            try 
            {
                await JSRuntime.InvokeVoidAsync("alert", "Please restart the application to complete re-initialization.");
            }
            finally
            {
                isLoading = false;
            }
        }
    }
}