@page "/Calendar"
@using Journal.Services
@using Journal.Models
@using System.Globalization
@inject IJournalService JournalService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject IFileService FileService

<div class="container">
    <!-- Header -->
    <div class="header">
        <h1>üìÖ Calendar View</h1>
        <div class="header-actions">
            <div class="view-toggle">
                <a href="/" class="view-btn">Timeline</a>
                <a href="/Calendar" class="view-btn active">Calendar</a>
            </div>
            <button class="btn btn-secondary" @onclick="ExportToPdf" style="margin-right: 0.5rem;">
                <i class="bi bi-file-earmark-pdf"></i> Export
            </button>
            <a href="/JournalEntry" class="btn btn-primary">+ New Entry</a>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Calendar Section -->
        <div class="calendar-section">
            <div class="calendar-header">
                <h2 class="month-year">@viewDate.ToString("MMMM yyyy")</h2>
                <div class="calendar-nav">
                    <button class="nav-btn" @onclick="PrevMonth">‚Üê</button>
                    <button class="today-btn" @onclick="GoToToday">Today</button>
                    <button class="nav-btn" @onclick="NextMonth">‚Üí</button>
                </div>
            </div>

            <div class="calendar">
                <div class="calendar-weekdays">
                    @foreach (var day in Enum.GetNames(typeof(DayOfWeek)))
                    {
                        <div class="weekday">@day.Substring(0, 3)</div>
                    }
                </div>

                <div class="calendar-days">
                    @foreach (var day in calendarDays)
                    {
                        <div class="calendar-day @(day.IsOtherMonth ? "other-month" : "") @(day.IsToday ? "today" : "") @(day.Date == selectedDate ? "selected" : "") @(day.HasEntries ? "has-entry" : "")"
                             @onclick="() => SelectDay(day.Date)">
                            <div class="day-number">@day.Date.Day</div>
                            @if (day.HasEntries)
                            {
                                <div class="day-entries">
                                    @foreach (var mood in day.Moods)
                                    {
                                        <div class="entry-dot @GetMoodClass(mood)"></div>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Selected Day Card -->
            <div class="sidebar-card">
                <div class="selected-day-info">
                    <div class="selected-date">@selectedDate.Day</div>
                    <div class="selected-day-name">@selectedDate.ToString("dddd, MMMM dd, yyyy")</div>
                </div>

                <h3>Entries for this day</h3>
                <div class="day-entries-list">
                    @if (selectedDayEntries.Any())
                    {
                        @foreach (var entry in selectedDayEntries)
                        {
                            <a href="/JournalEntry?id=@entry.Id" class="entry-item">
                                <div class="entry-time">@entry.CreatedAt.ToString("h:mm tt")</div>
                                <div class="entry-title-small">@entry.Title</div>
                                <span class="entry-mood-indicator">@GetMoodEmoji(entry.Mood) @entry.Mood</span>
                            </a>
                        }
                    }
                    else
                    {
                        <div class="no-entries">No entries for this day</div>
                        <a href="/JournalEntry" class="btn btn-secondary btn-sm" style="margin-top: 1rem;">Create Entry</a>
                    }
                </div>
            </div>

            <!-- Stats Card -->
            <div class="sidebar-card">
                <h3>This Month</h3>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value">@monthEntries.Count</div>
                        <div class="stat-label">Entries</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">@monthStreak</div>
                        <div class="stat-label">Streak</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">@avgWordCount</div>
                        <div class="stat-label">Avg Words</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">@activityPercent%</div>
                        <div class="stat-label">Days Active</div>
                    </div>
                </div>
            </div>

            <!-- Mood Legend -->
            <div class="sidebar-card">
                <h3>Mood Legend</h3>
                <div class="mood-legend">
                    <div class="legend-item">
                        <div class="legend-dot mood-happy"></div>
                        <span>üòä Happy</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot mood-calm"></div>
                        <span>üòå Calm</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot mood-neutral"></div>
                        <span>üòê Neutral</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot mood-reflective"></div>
                        <span>üòî Reflective</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot mood-sad"></div>
                        <span>üò¢ Sad</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private DateTime viewDate = DateTime.Today;
    private DateTime selectedDate = DateTime.Today;
    private List<JournalDisplayModel> monthEntries = new();
    private List<JournalDisplayModel> selectedDayEntries => monthEntries.Where(e => e.CreatedAt.Date == selectedDate.Date).ToList();
    private List<CalendarDayModel> calendarDays = new();

    // Stats
    private int monthStreak = 0;
    private string avgWordCount = "0";
    private int activityPercent = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadMonthData();
    }

    private async Task LoadMonthData()
    {
        var result = await JournalService.GetAllEntriesAsync(1, 1000); // Get all to filter
        if (result.Success && result.Data != null)
        {
            monthEntries = result.Data.Where(e => e.CreatedAt.Year == viewDate.Year && e.CreatedAt.Month == viewDate.Month).ToList();
            CalculateStats();
        }
        GenerateCalendar();
    }

    private void GenerateCalendar()
    {
        calendarDays.Clear();
        var firstDayOfMonth = new DateTime(viewDate.Year, viewDate.Month, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);

        // Start from the beginning of the week
        var startDate = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek);
        
        // Ensure 6 weeks are shown (42 days)
        for (int i = 0; i < 42; i++)
        {
            var date = startDate.AddDays(i);
            var entriesForDay = monthEntries.Where(e => e.CreatedAt.Date == date.Date).ToList();
            
            calendarDays.Add(new CalendarDayModel
            {
                Date = date,
                IsOtherMonth = date.Month != viewDate.Month,
                IsToday = date.Date == DateTime.Today,
                HasEntries = entriesForDay.Any(),
                Moods = entriesForDay.Select(e => e.Mood).Distinct().ToList()
            });
        }
    }

    private async Task PrevMonth()
    {
        viewDate = viewDate.AddMonths(-1);
        await LoadMonthData();
    }

    private async Task NextMonth()
    {
        viewDate = viewDate.AddMonths(1);
        await LoadMonthData();
    }

    private async Task GoToToday()
    {
        viewDate = DateTime.Today;
        selectedDate = DateTime.Today;
        await LoadMonthData();
    }

    private void SelectDay(DateTime date)
    {
        selectedDate = date;
    }

    private void CalculateStats()
    {
        if (!monthEntries.Any())
        {
            monthStreak = 0;
            avgWordCount = "0";
            activityPercent = 0;
            return;
        }

        avgWordCount = Math.Round(monthEntries.Average(e => e.WordCount)).ToString("N0");
        
        var daysInMonth = DateTime.DaysInMonth(viewDate.Year, viewDate.Month);
        var activeDays = monthEntries.Select(e => e.CreatedAt.Date).Distinct().Count();
        activityPercent = (int)((double)activeDays / daysInMonth * 100);

        // Simple streak for the month
        int streak = 0;
        var orderedDates = monthEntries.Select(e => e.CreatedAt.Date).Distinct().OrderByDescending(d => d).ToList();
        DateTime checkDate = DateTime.Today;
        if (checkDate.Year == viewDate.Year && checkDate.Month == viewDate.Month)
        {
             foreach(var date in orderedDates)
             {
                 if (date == checkDate)
                 {
                     streak++;
                     checkDate = checkDate.AddDays(-1);
                 }
                 else if (date < checkDate)
                 {
                     break;
                 }
                 else if (date < checkDate)
                 {
                     break;
                 }
             }
        }
        monthStreak = streak;
    }

    private async Task ExportToPdf()
    {
        try
        {
            if (!monthEntries.Any())
            {
                await JSRuntime.InvokeVoidAsync("alert", "No entries to export for this month.");
                return;
            }

            var sb = new System.Text.StringBuilder();
            sb.Append("<div style='max-width: 800px; margin: 0 auto;'>");
            sb.Append($"<h1 style='color: #1e293b; text-align: center; margin-bottom: 20px;'>Journal - {viewDate:MMMM yyyy}</h1>");
            sb.Append($"<p style='text-align: center; color: #64748b; margin-bottom: 40px;'>Total Entries: {monthEntries.Count}</p>");

            foreach (var e in monthEntries.OrderBy(e => e.CreatedAt))
            {
                sb.Append("<div style='margin-bottom: 30px; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px;'>");
                sb.Append("<div style='display: flex; justify-content: space-between; margin-bottom: 10px;'>");
                sb.Append($"<span style='color: #94a3b8; font-weight: 600;'>{e.CreatedAt:dddd, MMM dd}</span>");
                sb.Append($"<span style='background: #f1f5f9; padding: 2px 10px; border-radius: 999px; font-size: 0.8rem;'>{GetMoodEmoji(e.Mood)} {e.Mood}</span>");
                sb.Append("</div>");
                sb.Append($"<h2 style='color: #1e293b; margin: 0 0 10px 0;'>{e.Title}</h2>");
                sb.Append($"<div style='color: #475569; line-height: 1.5; white-space: pre-wrap;'>{e.Content}</div>");

                if (!string.IsNullOrEmpty(e.Tags))
                {
                    sb.Append("<div style='margin-top: 10px;'>");
                    foreach (var tag in e.Tags.Split(','))
                    {
                        sb.Append($"<span style='margin-right: 8px; color: #3b82f6; font-size: 0.85rem;'>#{tag.Trim()}</span>");
                    }
                    sb.Append("</div>");
                }
                sb.Append("</div>");
            }
            sb.Append("</div>");

            var fileName = $"Journal_{viewDate:yyyy_MM}.html";
            var filePath = await FileService.SaveHtmlFileAsync(sb.ToString(), fileName);
            await JSRuntime.InvokeVoidAsync("alert", $"Export successful! File saved to:\n{filePath}");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Export failed: {ex.Message}");
        }
    }

    private string GetMoodClass(string mood) => mood.ToLower() switch
    {
        "positive" => "mood-happy",
        "neutral" => "mood-neutral",
        "negative" => "mood-sad",
        _ => "mood-neutral"
    };

    private string GetMoodEmoji(string mood) => mood.ToLower() switch
    {
        "positive" => "üòä",
        "neutral" => "üòê",
        "negative" => "üòü",
        _ => "üòê"
    };

    public class CalendarDayModel
    {
        public DateTime Date { get; set; }
        public bool IsOtherMonth { get; set; }
        public bool IsToday { get; set; }
        public bool HasEntries { get; set; }
        public List<string> Moods { get; set; } = new();
    }
}